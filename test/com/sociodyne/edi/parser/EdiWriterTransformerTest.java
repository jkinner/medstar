package com.sociodyne.edi.parser;

import com.sociodyne.edi.Configuration;
import com.sociodyne.test.MockTest;

import java.io.ByteArrayInputStream;
import java.io.StringWriter;

import javax.xml.transform.Transformer;
import javax.xml.transform.TransformerConfigurationException;
import javax.xml.transform.TransformerFactory;
import javax.xml.transform.sax.SAXResult;
import javax.xml.transform.sax.SAXSource;

import org.xml.sax.InputSource;

public class EdiWriterTransformerTest extends MockTest {

  private static final Transformer transformer;

  static {
    final TransformerFactory tf = TransformerFactory.newInstance();
    try {
      transformer = tf.newTransformer();
    } catch (final TransformerConfigurationException e) {
      System.err.println("Unable to create JAXP Transformer");
      throw new RuntimeException(e);
    }
  }

  public void testRoundTripComplexDocument_succeeds() throws Exception {
    final String doc = "ISA*00*          *00*          *ZZ*TPG00094935    *ZZ*TPG00094935    *100413*0219*U*00401*240140919*0*P*:~GS*HB*OXFRD*LLX1210001*20100413*0219*1*X*004010X092A1~ST*271*000002624~BHT*0022*11*000002624*20100413*0219~HL*1**20*1~NM1*PR*2*OXFORD HEALTH PLANS*****PI*00016~HL*2*1*21*1~NM1*1P*2******XX*1770538696~HL*3*2*22*0~TRN*1*1162550050250413100218369*9MEDIFAX  ~NM1*IL*1*WEISSENBERGER*ERICH*G***MI*66572501~REF*EJ*8906~N3*2 WESTWOOD DR~N4*HADDONFIELD*NJ*08033*US~DMG*D8*19460217*M~EB*1*IND*30*C1*FREEDOM, FREEDOM*******Y~DTP*307*D8*20100413~EB*CB*IND*60~DTP*356*D8*19950415~EB*B*IND*49*C1*FREEDOM, FREEDOM**100*****Y~DTP*307*D8*20100413~EB*A*IND*49*****.3****N~DTP*307*D8*20100413~EB*C*IND*49****750*****N~DTP*307*D8*20100413~EB*B*IND*51*C1*FREEDOM, FREEDOM*27*50*****Y~DTP*307*D8*20100413~EB*B*IND*52*C1*FREEDOM, FREEDOM*27*50*****Y~DTP*307*D8*20100413~EB*B*IND*98*C1*FREEDOM, FREEDOM*27*20*****Y~DTP*307*D8*20100413~LS*2120~NM1*P3*1*HIGGINS*ALEXANDER****PI*JP111~PER*IC**TE*8565476000~LE*2120~EB*B*IND*98***27*20*****Y~DTP*307*D8*20100413~LS*2120~NM1*73*2~PER*IC*NO CONTACT INFO~LE*2120~EB*A*IND*98***27**.3****N~DTP*307*D8*20100413~EB*C*IND*98***27*750*****N~DTP*307*D8*20100413~EB*P**1~MSG*INFORMATION PROVIDED HEREIN IS NOT A GUARANTEE OF PAYMENT OR OF COVERAGE. BENEFIT DETERMINATIONS DEPEND ON A NUMBER OF FACTORS, INCLUDING MEDICAL NECESSITY. OXFORD EXPRESSLY RESERVES THE RIGHT TO CHANGE ANY INFORMATION PROVIDED.~HL*4*2*22*0~TRN*1*1104460050230413100218399*9MEDIFAX  ~NM1*IL*1*DAS*NEHA****MI*37968103~REF*EJ*8873~DMG*D8*20030519*F~INS*Y*18*001*25~EB*1*IND*30*C1*FREEDOM, FREEDOM*******Y~DTP*307*D8*20100413~EB*CB*IND*60~DTP*356*D8*20030519~EB*B*IND*49*C1*FREEDOM, FREEDOM**0*****Y~DTP*307*D8*20100413~EB*A*IND*49*****.2****N~DTP*307*D8*20100413~EB*C*IND*49****400*****N~DTP*307*D8*20100413~EB*B*IND*51*C1*FREEDOM, FREEDOM*27*50*****Y~DTP*307*D8*20100413~EB*B*IND*52*C1*FREEDOM, FREEDOM*27*50*****Y~DTP*307*D8*20100413~EB*B*IND*98*C1*FREEDOM, FREEDOM*27*15*****Y~DTP*307*D8*20100413~LS*2120~NM1*P3*1*THOMAS*SUSHEELA****PI*P465438~PER*IC**TE*9735840002~LE*2120~EB*B*IND*98***27*15*****Y~DTP*307*D8*20100413~LS*2120~NM1*73*2~PER*IC*NO CONTACT INFO~LE*2120~EB*A*IND*98***27**.2****N~DTP*307*D8*20100413~EB*C*IND*98***27*400*****N~DTP*307*D8*20100413~EB*P**1~MSG*INFORMATION PROVIDED HEREIN IS NOT A GUARANTEE OF PAYMENT OR OF COVERAGE. BENEFIT DETERMINATIONS DEPEND ON A NUMBER OF FACTORS, INCLUDING MEDICAL NECESSITY. OXFORD EXPRESSLY RESERVES THE RIGHT TO CHANGE ANY INFORMATION PROVIDED.~HL*5**20*1~NM1*PR*2*Oxford Health Plans*****PI*OXFRD~HL*6*5*21*1~NM1*IP*2******XX*1770538696~HL*7*6*22*1~TRN*1*1157110050240413100218449*9MEDIFAX  ~NM1*1L*1******MI*71204603~AAA*Y**67*C~HL*8*7*23*0~NM1*03*1*DAUBERT*JEREMY A~REF*EJ*8795~DMG*D8*19990222*M~DTP*307*D8*20100413~EB*V**30~MSG*50-RH0247 - PATIENT NOT FOUND~HL*9**20*1~NM1*PR*2*OXFORD HEALTH PLANS*****PI*00016~HL*10*9*21*1~NM1*1P*2******XX*1770538696~HL*11*10*22*0~TRN*1*1104730050230413100218476*9MEDIFAX  ~NM1*IL*1*CERNUTO*RYAN****MI*30859104~REF*EJ*8868~DMG*D8*20010918*M~INS*Y*18*001*25~EB*6**30~DTP*307*D8*20100413~EB*6*IND*49~DTP*307*D8*20100413~EB*6*IND*51~DTP*307*D8*20100413~EB*6*IND*52~DTP*307*D8*20100413~EB*6*IND*98***27~DTP*307*D8*20100413~EB*CB*IND*60~DTP*356*D8*20010918~EB*CB*IND*60~DTP*357*D8*20100131~EB*P**1~MSG*INFORMATION PROVIDED HEREIN IS NOT A GUARANTEE OF PAYMENT OR OF COVERAGE. BENEFIT DETERMINATIONS DEPEND ON A NUMBER OF FACTORS, INCLUDING MEDICAL NECESSITY. OXFORD EXPRESSLY RESERVES THE RIGHT TO CHANGE ANY INFORMATION PROVIDED.~HL*12*10*22*0~TRN*1*1157490050240413100218514*9MEDIFAX  ~NM1*IL*1*MOHANTY*NIBEDITA****MI*37968102~REF*EJ*8887~DMG*D8*19681217*F~EB*1*IND*30*C1*FREEDOM, FREEDOM*******Y~DTP*307*D8*20100413~EB*CB*IND*60~DTP*356*D8*19900901~EB*B*IND*49*C1*FREEDOM, FREEDOM**0*****Y~DTP*307*D8*20100413~EB*A*IND*49*****.2****N~DTP*307*D8*20100413~EB*C*IND*49****400*****N~DTP*307*D8*20100413~EB*B*IND*51*C1*FREEDOM, FREEDOM*27*50*****Y~DTP*307*D8*20100413~EB*B*IND*52*C1*FREEDOM, FREEDOM*27*50*****Y~DTP*307*D8*20100413~EB*B*IND*98*C1*FREEDOM, FREEDOM*27*15*****Y~DTP*307*D8*20100413~LS*2120~NM1*P3*1*PETERS*KAREN****XX*1609822501~PER*IC**TE*9733473277~LE*2120~EB*B*IND*98***27*15*****Y~DTP*307*D8*20100413~LS*2120~NM1*73*2~PER*IC*NO CONTACT INFO~LE*2120~EB*A*IND*98***27**.2****N~DTP*307*D8*20100413~EB*C*IND*98***27*400*****N~DTP*307*D8*20100413~EB*P**1~MSG*INFORMATION PROVIDED HEREIN IS NOT A GUARANTEE OF PAYMENT OR OF COVERAGE. BENEFIT DETERMINATIONS DEPEND ON A NUMBER OF FACTORS, INCLUDING MEDICAL NECESSITY. OXFORD EXPRESSLY RESERVES THE RIGHT TO CHANGE ANY INFORMATION PROVIDED.~HL*13*10*22*0~TRN*1*1157590050240413100218547*9MEDIFAX  ~NM1*IL*1*CASTIGLIONE*JESSICA****MI*15486105~REF*EJ*8918~DMG*D8*19970528*F~INS*Y*18*001*25~EB*1*IND*30*C1*FREEDOM, FREEDOM*******Y~DTP*307*D8*20100413~EB*CB*IND*60~DTP*356*D8*19970528~EB*B*IND*49*C1*FREEDOM, FREEDOM**0*****Y~DTP*307*D8*20100413~EB*A*IND*49*****.2****N~DTP*307*D8*20100413~EB*C*IND*49****250*****N~DTP*307*D8*20100413~EB*B*IND*51*C1*FREEDOM, FREEDOM*27*35*****Y~DTP*307*D8*20100413~EB*B*IND*52*C1*FREEDOM, FREEDOM*27*35*****Y~DTP*307*D8*20100413~EB*B*IND*98*C1*FREEDOM, FREEDOM*27*10*****Y~DTP*307*D8*20100413~LS*2120~NM1*P3*1*HAMMOND*BETTY****XX*1952345753~PER*IC**TE*7322541515~LE*2120~EB*B*IND*98***27*10*****Y~DTP*307*D8*20100413~LS*2120~NM1*73*2~PER*IC*NO CONTACT INFO~LE*2120~EB*A*IND*98***27**.2****N~DTP*307*D8*20100413~EB*C*IND*98***27*250*****N~DTP*307*D8*20100413~EB*P**1~MSG*INFORMATION PROVIDED HEREIN IS NOT A GUARANTEE OF PAYMENT OR OF COVERAGE. BENEFIT DETERMINATIONS DEPEND ON A NUMBER OF FACTORS, INCLUDING MEDICAL NECESSITY. OXFORD EXPRESSLY RESERVES THE RIGHT TO CHANGE ANY INFORMATION PROVIDED.~HL*14*10*22*0~TRN*1*1123870050220413100218585*9MEDIFAX  ~NM1*IL*1*FRIEDMAN*CHAYA****MI*42481708~REF*EJ*8950~DMG*D8*20051115*F~INS*Y*18*001*25~EB*1*IND*30*C1*FREEDOM, FREEDOM*******Y~DTP*307*D8*20100413~EB*CB*IND*60~DTP*356*D8*20051115~EB*B*IND*49*C1*FREEDOM, FREEDOM**500*****Y~DTP*307*D8*20100413~EB*A*IND*49*****.3****N~DTP*307*D8*20100413~EB*C*IND*49****3000*****N~DTP*307*D8*20100413~EB*B*IND*51*C1*FREEDOM, FREEDOM*27*150*****Y~DTP*307*D8*20100413~EB*B*IND*52*C1*FREEDOM, FREEDOM*27*150*****Y~DTP*307*D8*20100413~EB*B*IND*98*C1*FREEDOM, FREEDOM*27*30****N*Y~DTP*307*D8*20100413~LS*2120~NM1*P3*1*SHANIK*ROBERT****XX*1306864962~PER*IC**TE*7323410720~LE*2120~EB*B*IND*98***27*50*****Y~DTP*307*D8*20100413~LS*2120~NM1*73*2~PER*IC*NO CONTACT INFO~LE*2120~EB*A*IND*98***27**.3****N~DTP*307*D8*20100413~EB*C*IND*98***27*3000*****N~DTP*307*D8*20100413~EB*P**1~MSG*INFORMATION PROVIDED HEREIN IS NOT A GUARANTEE OF PAYMENT OR OF COVERAGE. BENEFIT DETERMINATIONS DEPEND ON A NUMBER OF FACTORS, INCLUDING MEDICAL NECESSITY. OXFORD EXPRESSLY RESERVES THE RIGHT TO CHANGE ANY INFORMATION PROVIDED.~HL*15*10*22*0~TRN*1*1163440050250413100219021*9MEDIFAX  ~NM1*IL*1*VAZQUEZ*JAMESON*A***MI*106147805~REF*EJ*8916~N3*119 EATON AVE~N4*TRENTON*NJ*08619*USA~DMG*D8*20040421*M~INS*Y*18*001*25~EB*1*IND*30*C1*HMO, FREEDOM*******Y~DTP*307*D8*20100413~EB*CB*IND*60~DTP*356*D8*20040421~EB*B*IND*49*C1*HMO, FREEDOM**500*****Y~DTP*307*D8*20100413~EB*B*IND*51*C1*HMO, FREEDOM*27*150*****Y~DTP*307*D8*20100413~EB*B*IND*52*C1*HMO, FREEDOM*27*150*****Y~DTP*307*D8*20100413~EB*B*IND*98*C1*HMO, FREEDOM*27*15****N*Y~DTP*307*D8*20100413~LS*2120~NM1*P3*1*SALTSTEIN*ELLIOTT****PI*MEP115~PER*IC**TE*6095815100~LE*2120~EB*B*IND*98***27*50*****Y~DTP*307*D8*20100413~LS*2120~NM1*73*2~PER*IC*NO CONTACT INFO~LE*2120~EB*P**1~MSG*INFORMATION PROVIDED HEREIN IS NOT A GUARANTEE OF PAYMENT OR OF COVERAGE. BENEFIT DETERMINATIONS DEPEND ON A NUMBER OF FACTORS, INCLUDING MEDICAL NECESSITY. OXFORD EXPRESSLY RESERVES THE RIGHT TO CHANGE ANY INFORMATION PROVIDED.~HL*16*10*22*0~TRN*1*1163620050250413100219064*9MEDIFAX  ~NM1*IL*1*CERNUTO*HAILEY BRIELLE****MI*30859103~REF*EJ*8867~DMG*D8*19991218*F~INS*Y*18*001*25~EB*6**30~DTP*307*D8*20100413~EB*6*IND*49~DTP*307*D8*20100413~EB*6*IND*51~DTP*307*D8*20100413~EB*6*IND*52~DTP*307*D8*20100413~EB*6*IND*98***27~DTP*307*D8*20100413~EB*CB*IND*60~DTP*356*D8*19991218~EB*CB*IND*60~DTP*357*D8*20100131~EB*P**1~MSG*INFORMATION PROVIDED HEREIN IS NOT A GUARANTEE OF PAYMENT OR OF COVERAGE. BENEFIT DETERMINATIONS DEPEND ON A NUMBER OF FACTORS, INCLUDING MEDICAL NECESSITY. OXFORD EXPRESSLY RESERVES THE RIGHT TO CHANGE ANY INFORMATION PROVIDED.~HL*17*10*22*0~TRN*1*1158100050240413100219090*9MEDIFAX  ~NM1*IL*1*MCDUFFIE*XAVIER*C***MI*35299104~REF*EJ*8797~DMG*D8*19970626*M~INS*Y*18*001*25~EB*6**30~DTP*307*D8*20100413~EB*6*IND*49~DTP*307*D8*20100413~EB*6*IND*51~DTP*307*D8*20100413~EB*6*IND*52~DTP*307*D8*20100413~EB*6*IND*98***27~DTP*307*D8*20100413~EB*CB*IND*60~DTP*356*D8*19970626~EB*CB*IND*60~DTP*357*D8*20090630~EB*P**1~MSG*INFORMATION PROVIDED HEREIN IS NOT A GUARANTEE OF PAYMENT OR OF COVERAGE. BENEFIT DETERMINATIONS DEPEND ON A NUMBER OF FACTORS, INCLUDING MEDICAL NECESSITY. OXFORD EXPRESSLY RESERVES THE RIGHT TO CHANGE ANY INFORMATION PROVIDED.~SE*314*000002624~GE*1*1~IEA*1*240140919~";
    final EdiXmlReader reader = EdiXmlReader.Factory.create();
    final Configuration writeConfiguration = new Configuration.Builder().setSegmentTerminator('~')
        .setElementSeparator('*').setSubElementSeparator(':').build();
    final ByteArrayInputStream is = new ByteArrayInputStream(doc.getBytes());
    final StringWriter stringWriter = new StringWriter();
    final XmlEdiWriter xmlEdiWriter = new XmlEdiWriter(new EdiWriter(writeConfiguration,
        stringWriter));
    final SAXResult output = new SAXResult(xmlEdiWriter);
    transformer.transform(new SAXSource(reader, new InputSource(is)), output);
    stringWriter.close();
    assertEquals(doc, stringWriter.toString());
  }

}
